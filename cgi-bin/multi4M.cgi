#!/usr/bin/perl###################################################################### Multi4M 1.0 - Multi-forum threaded message board# Copyright 1996 by Innergy Inc.# # Developed by:  # 	Gordon Benett		<gbenett@innergy.com># based on the freeware 'WWWadmin' by:# 	Matt Wright			<mattw@worldwidemart.com>## Requires Perl 5.x (for hard references).# Use constitutes acceptance of terms:# Script is offered as-is, with NO WARRANTY whatsoever.# May be copied, distributed and used with attribution # as long as copyright notice is intact.# Bug reports can be sent to <ThisOldWeb@innergy.com>#################################################################### Revisions# # 11/16/96  v1.0 globals centralized in CFG file# 10/15/96  v0.95beta bug fixes, removed user_img option# 10/10/96  v0.9beta of multi-forum routines###################################################################### Description## This script manages one or more discussion forums, each of which # must have the following structure:##>  $homepath           # e.g., '/home/users/~mysite/public_html/'#     |                 #       (include trailing slash)#     |-- $bb_id      # e.g., 'forum->Intranet Exchange'#>    |     |-- $msgdir # e.g., 'msgs'#>    |     |-- $arcdir # e.g., 'archive'#     |#     |-- $bb_id      # e.g., 'guestbook->Visitors List'#     |     |-- $msgdir # e.g., 'msgs'#     |     |-- $arcdir # e.g., 'archive'#     |#     |-- $bb_id      # e.g., 'jobsOffered->Employment Opportunites'#     |     |-- $msgdir #     |     |-- $arcdir ## Variables marked with a '>' are hard-coded in the script. Others# can be set at run-time via hidden fields in HTML forms. This allows # new forums to be set up quickly without modfying scripts.## Embedded vars supported:#	'bb_id' is a unique identifier composed as follows:#		"$bb_dir" . "$sep" . "$bb_name"###################################################################  use strict 'refs';	# ensures safe pointers in Perl 5  require( 'multi4M.cfg' ) || &error(bad_include);##################################################################### Setup (local portion)## URL of this script    $cgi_url = "http://www.audiorom.com/cgi-bin/$forumProg";# Preset program options#    $linkFAQ = 0;       # 1 - YES; 0 = NO    $faqfile = '';      # full path needed iff linkFAQ    $quoteOrig = 0;     # 1 - YES; 0 = NO    $quoteChar = ':';   # sets off quoted original    $subjectStyle = 0;  # 0=Quote Subject Editable                        # 1=Quote Subject UnEditable                        # 2=Don't Quote Subject, Editable# Time- as well as date-stamp threads?    $timeStyle = 1;     # 1=date/time; 0=date only## Setup ends###################################################################### Main sequence## Get HTML Form name/value pairs&parseForm;print "Content-type: text/html\n\n";# Validate and store input data&loadVars;# Get local date/time&getDate;# Get next msg number&getMsgNum;# Write new message&newPost;# Update main board&mainPage;# If followup, add Thread to Individual Pagesif ($num_followups >= 1) {   &threadPages;}# Return the user HTML# NC: Changed this page to be more decent 13/03/97&returnPage;# Increment Msg Number&nextMsgNum;######################## Local subroutinessub loadVars {# ------------------------------------------# Clean up input # ------------------------------------------	($bb_dir, $bb_name) = split(/$sep/, $FORM{'bb_id'});    &error('bad_dir') unless -d "$homepath/$bb_dir";   if ($FORM{'reply'}) {      $reply = "1";      @followup_num = split(/,/,$FORM{'reply'});      $num_followups = @followups = @followup_num;      $last_msg = pop(@followups);      $origdate = "$FORM{'origdate'}";      $origname = "$FORM{'origname'}";      $origsubject = "$FORM{'origsubject'}";   }   else {      $reply = "0";   }   if ($FORM{'name'}) { # Poster's name      $name = "$FORM{'name'}";      $name =~ s/["<>&]//g;     # strip HTML chars from names   }   else {      &error(no_name);   }   if ($FORM{'email'} =~ /.*\@.*\..*/) {      $email = "$FORM{'email'}";   }   if ($FORM{'subject'}) {      $subject = "$FORM{'subject'}";      $subject =~ s/\&/\&amp\;/g;   # HTMLize special chars      $subject =~ s/"/\&quot\;/g;   }   else {      &error(no_subject);   }   if ($FORM{'url'} =~ /.*\:.*\..*/ && $FORM{'url_title'}) {      $userURL = "$FORM{'url'}";      $user_url_title = "$FORM{'url_title'}";   }    if ($FORM{'allowTags'} =~ /[01]/) {        $allowTags = "$FORM{'allowTags'}";    }       if ($FORM{'body'}) {      $body = "$FORM{'body'}";      &stripHTML( $body ) if ($allowTags ne '1');      $body =~ s/\cM//g;      $body =~ s/\n\n/<p>/g;      $body =~ s/\n/<br>/g;      $body =~ s/&lt;/</g;       $body =~ s/&gt;/>/g;       $body =~ s/&quot;/"/g;   }   else {      &error(no_body);   }      if ($quoteOrig == 1) {      $hidden_body = "$body";      $hidden_body =~ s/</&lt;/g;      $hidden_body =~ s/>/&gt;/g;      $hidden_body =~ s/"/&quot;/g;   }}sub newPost {# ------------------------------------------# Create new message file# ------------------------------------------   local( $newfile ) = "$homepath/$bb_dir/$msgdir/$msgnum\.$ext";       open(POST,">$newfile") || &error("bad_open");   &mkHead( $subject, "$homeURL/$bb_dir/", 'POST');   print POST "<body background=\"$MSG_IMAGE\" text=\"$MSG_TEXT\" LINK=\"$MSG_LINK\" VLINK=\"$MSG_VLINK\">\n";   if ($bb_dir eq "soundings") {      print POST <<OUT;      <center>  <IMG SRC="smb.gif" ALT="Soundings Message Board"><table border=0 cellpadding=20><tr><td><a href="../developer/index.html"><img src="/images/dlink.gif" border=0 alt="developer"></a></td> <td><a href="../muso/index.html"><img src="/images/mlink.gif" border=0 alt="muso "></a></td>                                                                      <td><a href="../general/index.html"><img src="/images/glink.gif" border=0 alt="g eneral"></a></td>                                                                </tr></table>                                                                      <P></center>OUT   }   elsif ($bb_dir eq "muso") {      print POST<<OUT;<center>  <IMG SRC="mmb.gif" ALT="Muso Message Board"><table border=0 cellpadding=20><tr><td><a href="../developer/index.html"><img src="/images/dlink.gif" border=0 alt="developer"></a></td> <td><a href="../soundings/index.html"><img src="/images/slink.gif" border=0 alt="muso "></a></td>                                                                      <td><a href="../general/index.html"><img src="/images/glink.gif" border=0 alt="g eneral"></a></td>                                                                </tr></table>                                                                      <P></center>OUT   }   elsif ($bb_dir eq "developer") {  print POST<<OUT;<center>  <IMG SRC="dmb.gif" ALT="Developer Message Board"><table border=0 cellpadding=20><tr><td><a href="../soundings/index.html"><img src="/images/slink.gif" border=0 alt="developer"></a></td> <td><a href="../muso/index.html"><img src="/images/mlink.gif" border=0 alt="muso "></a></td>                                                                      <td><a href="../general/index.html"><img src="/images/glink.gif" border=0 alt="g eneral"></a></td>                                                                </tr></table>                                                                      <P></center>OUT   }   elsif ($bb_dir eq "general") {print POST<<OUT;<center>  <IMG SRC="gmb.gif" ALT="General Message Board"><table border=0 cellpadding=20><tr><td><a href="../developer/index.html"><img src="/images/dlink.gif" border=0 alt="developer"></a></td> <td><a href="../muso/index.html"><img src="/images/mlink.gif" border=0 alt="muso "></a></td>                                                                      <td><a href="../sounding/index.html"><img src="/images/slink.gif" border=0 alt="g eneral"></a></td>                                                                </tr></table>                                                                      <P></center>OUT   }   print POST "<h1 align=\"center\">$subject</h1>\n";   &buttonbar;   print POST "Posted by ";   print POST ($email ? "<a href=\"mailto:$email\">$name</a>" : "$name");   print POST " on $longDate:<p>\n";   if ($reply == 1) {      print POST "In Reply to: <a href=\"$msgdir/$last_msg\.$ext\">$origsubject</a> posted by ";      print POST ($origemail ? "<a href=\"$origemail\">$origname</a>" : "$origname");      print POST " on $origdate:<p>\n";   }   print POST "<blockquote>$body</blockquote>\n";   if ($userURL) {      print POST "<ul><li><a href=\"$userURL\">$user_url_title</a></ul>\n";   }   print POST "<br>\n";   # demark Followup listing   print POST "<a name=\"followups\">Follow Ups:</a><br>\n";   print POST "<ul><!--insert: $msgnum-->\n";   print POST "</ul><!--end: $msgnum-->\n";   print POST "<br>\n";   # demark Followup entry form   print POST "<H4><a name=\"postfp\">Post a Followup</a></H4>\n";   print POST "<form method=POST action=\"$cgi_url\">\n";   print POST "<input type=hidden name=\"reply\" value=\"";   if ($reply == 1) {       # in hidden field 'reply', list msgs in thread      foreach (@followup_num) {         print POST "$_,";      }   }   print POST "$msgnum\">\n";   print POST "<input type=hidden name=\"origname\" value=\"$name\">\n";   if ($email) {      print POST "<input type=hidden name=\"origemail\" value=\"$email\">\n";   }   print POST "<input type=hidden name=\"origsubject\" value=\"$subject\">\n";   print POST "<input type=hidden name=\"origdate\" value=\"$longDate\">\n";   print POST "<input type=hidden name=\"bb_id\" value=\"$FORM{'bb_id'}\">\n";   print POST "<input type=hidden name=\"allowTags\" value=\"$allowTags\">\n";      # Begin pre-formatted section   print POST "<pre>";   print POST "Name:     <input type=text name=\"name\" size=41>\n";   print POST "E-Mail:   <input type=text name=\"email\" size=41><p>\n";   if ($subjectStyle == 1) {      if ($subjectStyle =~ /^Re:/) {         print POST "<input type=hidden name=\"subject\" value=\"$subject\">\n";         print POST "Subject:  <b>$subject</b><p>\n";      }      else {         print POST "<input type=hidden name=\"subject\" value=\"Re: $subject\">\n";         print POST "Subject:  <b>Re: $subject</b><p>\n";      }   }    elsif ($subjectStyle == 2) {      print POST "Subject:  <input type=text name=\"subject\" size=41><p>\n";   }   else {      if ($subject =~ /^Re:/) {         print POST "Subject:  <input type=text name=\"subject\"value=\"$subject\" size=41><p>\n";      }      else {         print POST "Subject:  <input type=text name=\"subject\" value=\"Re: $subject\" size=41><p>\n";      }   }   print POST "Message:<br>\n";   print POST "<textarea name=\"body\" COLS=40 ROWS=10>\n";   if ($quoteOrig == 1) {      @bodyBlock = split(/\&lt\;p\&gt\;/,$hidden_body);      foreach (@bodyBlock) {         @bodyLine = split(/\&lt\;br\&gt\;/);         foreach $quoteLine (@bodyLine) {            print POST "$quoteChar $quoteLine\n";         }         print POST "\n";      }   }   print POST "</textarea><p align=\"center\">\n";   print POST "<input type=submit value=\"Submit Follow Up\"> <input type=reset value=\"Clear\"></p>\n";   print "</pre>\n";   &buttonbar;   print POST "</body></html>\n";   close(POST);}sub mainPage {# ------------------------------------------#   Main Msg Board Update# ------------------------------------------   open(MAIN,"$homepath/$bb_dir/$bb_file") || &error("$homepath/$bb_dir/$bb_file bad_open");   @main = <MAIN>;  # slurp main board for update    close(MAIN);   open(MAIN,">$homepath/$bb_dir/$bb_file") || &error(" $homepath/$bb_dir/$bb_file bad_open");   if ($reply == 0) {      foreach $main_line (@main) {         if ($main_line =~ /<!--begin-->/) {            print MAIN "<!--begin-->\n";        print MAIN "<!--top: $msgnum--><li><a href=\"$msgdir/$msgnum\.$ext\">$subject</a> - <b>$name</b> <i>$date</i>\n";            print MAIN "(<!--responses: $msgnum-->0)\n";            print MAIN "<ul><!--insert: $msgnum-->\n";            print MAIN "</ul><!--end: $msgnum-->\n";         }         else {            print MAIN "$main_line";         }      }   }   else {     foreach $_ (@main) {     $work = 0;         if (/<ul><!--insert: $last_msg-->/) {            print MAIN "<ul><!--insert: $last_msg-->\n";            print MAIN "<!--top: $msgnum--><li><a href=\"$msgdir/$msgnum\.$ext\">$subject</a> - <b>$name</b> <i>$date</i>\n";            print MAIN "(<!--responses: $msgnum-->0)\n";            print MAIN "<ul><!--insert: $msgnum-->\n";            print MAIN "</ul><!--end: $msgnum-->\n";         }         elsif (/\(<!--responses: (.*)-->(.*)\)/) {            $reply_num = $1;            $num_replies = $2;            $num_replies++;            foreach $num (@followup_num) {               if ($num == $reply_num) {                  print MAIN "(<!--responses: $reply_num-->$num_replies)\n";          $work = 1;               }            }            if ($work != 1) {               print MAIN;            }         }         else {            print MAIN;         }      }   }   close(MAIN);}sub threadPages {# ------------------------------------------# Add Followup Threading to Individual Pages# ------------------------------------------    local( $msg,$num,$line,@lines );   foreach $msg (@followup_num) {      open(REPLY,"$homepath/$bb_dir/$msgdir/$msg\.$ext");      @lines = <REPLY>;     # slurp file for threading      close(REPLY);      open(REPLY,">$homepath/$bb_dir/$msgdir/$msg\.$ext");      foreach $line (@lines) {         $work = 0;         if ($line =~ /<ul><!--insert: $last_msg-->/) {            print REPLY "<ul><!--insert: $last_msg-->\n";            print REPLY "<!--top: $msgnum--><li><a href=\"$msgdir/$msgnum\.$ext\">$subject</a> <b>$name</b> <i>$date</i>\n";            print REPLY "(<!--responses: $msgnum-->0)\n";            print REPLY "<ul><!--insert: $msgnum-->\n";            print REPLY "</ul><!--end: $msgnum-->\n";         }         elsif ($line =~ /\(<!--responses: (.*)-->(.*)\)/) {            $reply_num = $1;            $num_replies = $2 + 1;            foreach $num (@followup_num) {               if ($num == $reply_num) {                  print REPLY "(<!--responses: $num-->$num_replies)\n";                  $work = 1;               }            }            if ($work != 1) {               print REPLY "$line";            }         }         else {            print REPLY "$line";         }      }      close(REPLY);   }}sub returnPage {# ------------------------------------------# Feedback to poster# ------------------------------------------   # NC: removed this call to head function print outs 13/03/97   #&mkHead( "Message Added: $subject", "$homeURL/$bb_dir/" );   # NC: replaced with specific head print out   #print "Content-type: text/html\n\n";   print "<HTML><HEAD>\n";   print "<title>$title</title>\n";   print "<base href=\"$base\">\n";   print "<META HTTP-EQUIV=\"Refresh\" CONTENT=\"5; URL=http://www.audiorom.com/Interact/forum/$bb_dir/$bb_file\">\n";   print "</head>\n";   print "<body BGCOLOR=\"#000000\" text=\"$MSG_TEXT\" LINK=\"$MSG_LINK\" VLINK=\"$MSG_VLINK\">\n";   print "<h1 align=\"center\">Message Added: $subject</h1>\n";   print "The following information was added to the message board:\n";   print "<p>\n";   print "<b>Name:</b> $name<br>\n";   print "<b>E-Mail:</b> $email<br>\n";   print "<b>Subject:</b> $subject<br>\n";   print "<b>Body of Message:</b><p>\n";   print "$body<p>\n";   if ($userURL) {      print "<b>Link:</b> <a href=\"$userURL\">$user_url_title</a><br>\n";   }   print "<b>Added on Date:</b> $date<p>\n";   print "</body></html>\n";}sub nextMsgNum {# ------------------------------------------# Increment message count# ------------------------------------------   if ($msgnum == $MAX_MSGNUM)  { # roll over odometer      $msgnum = 1;   }   else {      $msgnum++;   }   open(NUM, ">$homepath/$bb_dir/$msgCountFile") || &error(" $homepath/$bb_dir/$msgCountFile bad_open");   print NUM "$msgnum";   close(NUM);}sub getMsgNum {# ------------------------------------------# Get sequence number for new msg# ------------------------------------------   open(NUM,"$homepath/$bb_dir/$msgCountFile") || &error("$homepath/$bb_dir/$msgCountFile bad_open");   $msgnum = <NUM>;         # slurp first line   close(NUM);}sub error {#-----------------------------------------# Error handler. Arg is string specifying error type.#-----------------------------------------   $error = $_[0];   local( $msg, $detail );   # Handle various errors   if ($error eq 'no_name') {      $msg = "$bb_name ERROR: No Name";      $detail = "You forgot to fill in the 'Name' field in your posting.  Correct it below and re-submit.  Required fields are: Name, Subject and Message.";   }   elsif ($error eq 'no_subject') {      $msg = "$bb_name ERROR: No Subject";      $detail = "You forgot to fill in the 'Subject' field in your posting.  Correct it below and re-submit.  The necessary fields are: Name, Subject and Message.";   }   elsif ($error eq 'no_body') {      $msg = "$bb_name ERROR: No Message";      $detail = "You forgot to fill in the 'Message' field in your posting.  Correct it below and re-submit.  The necessary fields are: Name, Subject and Message.";   }   elsif ($error eq 'no_title') {      $msg = "Forum ERROR: No Title";      $detail = "The form you submitted is missing an embedded title.";   }   elsif ($error eq 'bad_open') {      $msg = "messdir $msgdir mesfile $msgnum thefile $bb_file bbdir $bb_dir homepath $homepath $bb_name ERROR: File Open Failed\n";      $detail = "The forum script could not open a file needed for processing.<br>";	  $detail .= "<b>System status:</b> <i>$!</i><p>";	  $detail .= "Check the file permissions or contact the sysadmin.";   }   elsif ($error eq 'bad_dir') {      $msg = "$bb_name ERROR: Directory Not Found";	  $detail = "<b>System status:</b> <i>$!</i><p>";      $detail .= "$homepath and $bb_dir The forum script was unable to find your message<br>";	  $detail .= "subdirectory. Check file permissions or contact the sysadmin.";   }   elsif ($error eq 'bad_include') {      print "Content-type: text/html\n\n";      $msg = "Required File Not Found";	  $detail = "<b>System status:</b> <i>$!</i><p>";      $detail .= "The forum script was unable to include <br>";	  $detail .= "a required file. Check file permissions or contact the sysadmin.";   }   else {      $msg = "$bb_name ERROR: Unknown";	  $detail = "<b>System status:</b> <i>$!</i><p>\n";      $detail .= "The forum script encountered an uncharacterized error. $error .Contact the site webmaster.";   }   &mkHead( $msg, "$homeURL/" );   print "<body><h2 align=\"center\">$msg</h2>\n";   print "<p>$detail<\p>\n";   print "<pre>\n\n</pre>\n";   print "<hr size=4 width=75%>\n";   &finishForm;   exit(1);}sub buttonbar {             # assumes base href = $bb_dir   local( $url ) = "$msgdir/$msgnum\.$ext";   print POST "<hr size=4 width=\"75%\">\n";   print POST "<p align=\"center\">[ <a href=\"$url#followups\">Follow Ups</a> ] ";   print POST "[ <a href=\"$url#postfp\">Post Followup</a> ] ";   print POST "[ <a href=\"$bb_file\">$bb_name</a> ] ";   if ($linkFAQ == 1) {      print POST "[ <a href=\"$faqfile\">FAQ</a> ]";   }   print POST "</p>\n<hr size=4 width=\"75%\"><p>\n";}sub finishForm {   print "<form method=POST action=\"$cgi_url\">\n";   if ($reply == 1) {      print "<input type=hidden name=\"origsubject\" value=\"$FORM{'origsubject'}\">\n";      print "<input type=hidden name=\"origname\" value=\"$FORM{'origname'}\">\n";      print "<input type=hidden name=\"origemail\" value=\"$FORM{'origemail'}\">\n";      print "<input type=hidden name=\"origdate\" value=\"$FORM{'origdate'}\">\n";      print "<input type=hidden name=\"reply\" value=\"$FORM{'reply'}\">\n";   }   print "Name: <input type=text name=\"name\" value=\"$FORM{'name'}\" size=50><br>\n";   print "E-Mail: <input type=text name=\"email\" value=\"$FORM{'email'}\" size=50><p>\n";   if ($subjectStyle == 1) {      print "<input type=hidden name=\"subject\" value=\"$FORM{'subject'}\">\n";      print "Subject: <b>$FORM{'subject'}</b><p>\n";   }    else {      print "Subject: <input type=text name=\"subject\" value=\"$FORM{'subject'}\" size=50><p>\n";   }   print "Message:<br>\n";   print "<textarea COLS=60 ROWS=10 name=\"body\">\n";   $_ = $FORM{'body'};    s/</&lt;/g;   s/>/&gt;/g;   s/"/&quot;/g;   print ;   print "\n</textarea><p>\n";   print "<input type=hidden name=\"bb_id\" value=\"$FORM{'bb_id'}\">\n";   print "<input type=hidden name=\"allowTags\" value=\"$FORM{'allowTags'}\">\n";   print "Optional Link URL: <input type=text name=\"url\" value=\"$FORM{'url'}\" size=45><br>\n";   print "Link Title: <input type=text name=\"url_title\" value=\"$FORM{'url_title'}\" size=50><br>\n";   print "<input type=submit value=\"Post Message\"> <input type=reset value=\"Clear\">\n";   print "</form>\n";   print "<p><hr size=4 width=\"75%\">\n";   print "<p align=\"center\">[ <a href=\"$bb_dir/$bb_file\">$bb_name</a> ]</p>\n\n";   print "</body></html>\n";}