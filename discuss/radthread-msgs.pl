#**********************************************************************#* Program:      Hyperthread-LITE from Radiation                      *#* Module:       Messaging Routines                                   *#* Version:      1.0                                                  *#* Author:       Andrew Cowan (icculus@radiation.com) for Radiation   *#* Date:         January 7, 1997                                      *#* Product Info: http://www.radiation.com/gizmos/htlite.html          *#*                                                                    *#* This program is the copyrighted property of Radiation, a venture   *#* of GlobalMedia Design. Any use of this program is subject to the   *#* the terms of the license agreement (LICENSE.TXT) included as part  *#* of this distribution archive. Any other uses are stictly           *#* prohibited without the written permission of GlobalMedia Design    *#* and all other rights are reserved.                                 *#*                                                                    *#* Support for this software is available only to registered users.   *#* For registration information, consult the REGISTER.TXT document    *#* included as part of this distribution archive, or visit the Gizmos *#* section of the Radiation website at:                               *#*                                                                    *#*                http://www.radiation.com/gizmos/                    *#*                                                                    *#**********************************************************************# ************************************************************************# Module Subroutines Section# ************************************************************************# ************************************************************************# Load_Messages - Loads the message base for a particular area # ************************************************************************sub load_messages{   $#message_nums = -1;   local($this_area) = $_[0]; # Grab passed area keyword   # Define the message database for this area   $message_db = $db_dir . "/" . $this_area;   dbmopen(%DB, $message_db, 0666);   %TDB = %DB;   dbmclose(DB);   local($max) = 0;   while(($key, $val) = each(%TDB)){      $max = $key if $key > $max;   }   # Load all of the messages for this area   $first_message_num = "NONE";   for ($key = 1; $key <= $max; $key++){       next unless defined($TDB{$key});       $val = $TDB{$key};       if ($val !~ /(.*)\t(.*)\t(.*)\t(.*)\t(.*)\t(.*)\t(.*)\t(.*)/){          delete $TDB{$key};          next;       }        local($number) = $key;       $status{$number} = $1;       $thread_start{$number} = $2;       $parent{$number} = $3;       $date{$number} = $4;       $name{$number} = $5;       $email{$number} = $6;       $subject{$number} = $7;       $orig_message{$number} = $message{$number} = $8;       $message{$number} =~ s/`~``~`/<p>/g;       $message{$number} =~ s/`~`/ /g;       $replies{$parent{$number}} = "YES" if ($status{$number} =~ /REPLY/);        $first_message_num = $number if $first_message_num eq "NONE";       push(@message_nums, $number);       $last_message_num = $number;   }}# ************************************************************************# Message_handler - System for handling messages on a specific area # ************************************************************************sub message_handler{   local($this_area) = $_[0];   &load_messages($this_area);   &print_area_button_bar($this_area);   print "<center><h3>$area_name{$this_area}</h3></center>";   if ($first_message_num eq "NONE"){      print "<center><h4>There are no messages posted to this area.</h4>" .            "</center>";      &print_area_button_bar($this_area);      return;   }   print "<ol><ol>";   foreach $msg_num (@message_nums){      next if ($status{$msg_num} =~ /REPLY/);      $msg_url = $cgi_url . "?mode=MSG&message=$msg_num";       if ($status{$msg_num} =~ /EXPIRED/){         print "<li><b>$subject{$msg_num}</b> \n" .               "(<font size=-1><a href=\"mailto:$email{$msg_num}\">" .               "$name{$msg_num}</a></font>) $date{$msg_num} " .               "<b><em>Expired</em></b>";      }else{         print "<li><b><a href=\"$msg_url\">$subject{$msg_num}</b></a> \n" .               "(<font size=-1><a href=\"mailto:$email{$msg_num}\">" .               "$name{$msg_num}</a></font>) $date{$msg_num}";      }      if ($replies{$msg_num} eq "YES"){         local($reply_string) = &find_thread($msg_num);         (@reply_list) = (split(/:/, $reply_string));          print "<ul>";         foreach $reply (@reply_list){            $rmsg_url = $cgi_url . "?mode=MSG&message=$reply";             if ($status{$reply} =~ /EXPIRED/){               print "<li><b>$subject{$reply}</b> \n" .                     "(<font size=-1><a href=\"mailto:$email{$reply}\">" .                     "$name{$reply}</a></font>) $date{$reply} " .                     "<b><em>Expired</em></b>";            }else{               print "<li><b><a href=\"$rmsg_url\">$subject{$reply}</b></a> \n" .                     "(<font size=-1><a href=\"mailto:$email{$reply}\">" .                     "$name{$reply}</a></font>) $date{$reply}";            }         }         print "</ul>";      }   }   print "</ol></ol>";   &print_area_button_bar($this_area);}# ************************************************************************# Display_Message - Display the message # ************************************************************************sub display_message{   local($this_area, $this_message, $notes) = @_;   &load_messages($this_area);   &print_header("$area_name{$this_area} :: $subject{$this_message}");   &print_msg_button_bar($this_area, $this_message);   $msg_poster = $name{$this_message};   $email_tag = "(<a href=\"mailto:$email{$this_message}\">" .                   "$email{$this_message}</a>)";   print <<"EOF";<center><FONT SIZE=+2><B>$area_name{$this_area}</B></FONT></center><p><UL><UL><FONT SIZE=+1><B><em>$subject{$this_message}</em></B></FONT><BR><b>Date: <em>$date{$this_message}</em></b><br><b>Posted By: <em>$msg_poster</em> $email_tag</b><br><p>$message{$this_message}<p>EOF   if ($parent{$this_message} ne "NONE"){      local($msg_num) = $parent{$this_message};      $msg_url = $cgi_url . "?mode=MSG&message=$msg_num";       if ($status{$msg_num} =~ /EXPIRED/){         print "<b>In Reply To:</b> " .               "<b>$subject{$msg_num}</b> \n" .               "(<font size=-1><a href=\"mailto:$email{$msg_num}\">" .               "$name{$msg_num}</a></font>) <b><em>Expired</em></b><p>";      }else{         print "<b>In Reply To:</b> " .               "<b><a href=\"$msg_url\">$subject{$msg_num}</b></a> \n" .               "(<font size=-1><a href=\"mailto:$email{$msg_num}\">" .               "$name{$msg_num}</a></font>)<p>";      }   }   local($reply_string) = &find_replies($this_message);   if ($reply_string ne ""){      print "<b>Replies:</b><ul>";      (@reply_list) = (split(/:/, $reply_string));       foreach $msg_num (@reply_list){         $msg_url = $cgi_url . "?mode=MSG&message=$msg_num";                   if ($status{$msg_num} =~ /EXPIRED/){            print "<li><b>$subject{$msg_num}</b> \n" .                  "(<font size=-1><a href=\"mailto:$email{$msg_num}\">" .                  "$name{$msg_num}</a></font>) <b><em>Expired</b></em>";         }else{            print "<li><b><a href=\"$msg_url\">$subject{$msg_num}</b></a> \n" .                  "(<font size=-1><a href=\"mailto:$email{$msg_num}\">" .                  "$name{$msg_num}</a></font>)";         }      }      print "</ul>";   }   print "</ul></ul>";   &print_msg_button_bar($this_area, $this_message);   &print_footer;}# ************************************************************************# Post_Form - Form for posting messages# ************************************************************************sub post_form{   local($this_area, $post_mode) = @_;   if ($post_mode eq "NEW"){      &print_header("$area_name{$this_area} :: Post New Message");      &print_post_button_bar($this_area);       print <<"EOF";<center><h3>$area_name{$this_area} :: Post New Message</h3></center><form method="post" action="$cgi_url"><input type="hidden" name="area" value="$this_area"><input type="hidden" name="mode" value="NEW_POST"><ul><input type="text" name="name" size="35"> Your Name<br><input type="text" name="email" size="35"> Your Email Address<br><input type="text" name="subject" size="35"> Message Subject<br><textarea name="message_body" rows="15" cols="50"></textarea></ul><center><input type="submit" value=" Post Message "></center></form>EOF   }elsif ($post_mode eq "REPLY"){      &load_messages($this_area);      &print_header("$area_name{$this_area} :: Post Reply");      &print_msg_button_bar($this_area, $message);   $msg_poster = $name{$message};   $email_tag = "(<a href=\"mailto:$email{$message}\">" .                   "$email{$message}</a>)";   print <<"EOF";<center><FONT SIZE=+1><B>$area_name{$this_area}</B></FONT></center><p><UL><b><em>You are replying to:</em></b><P><UL><b>Subject: <em>$subject{$message}</em></b><br><b>Date: <em>$date{$message}</em></b><br> <b>Posted By: <em>$msg_poster</em> $email_tag</b><p>$message{$message}</ul></ul><p><hr width=95%><p><form method="post" action="$cgi_url"><input type="hidden" name="area" value="$this_area"><input type="hidden" name="message" value="$message"><input type="hidden" name="mode" value="REPLY_POST"><ul><input type="text" name="name" size="35"> Your Name<br><input type="text" name="email" size="35"> Your Email Address<br><input type="text" name="subject" value="RE: $subject{$message}" size="35"> Message Subject<br><textarea name="message_body" rows="15" cols="60"></textarea></ul><center><input type="submit" value=" Post Reply "></center></form>EOF   }   &print_post_button_bar($this_area);      &print_footer;}# ************************************************************************# Post_Handler - Handler routine for message posting# ************************************************************************sub post_handler{   local($this_area, $post_mode) = @_;   if ($post_mode eq "NEW"){      local($form_missing) = &check_for_missing;      if ($form_missing ne ""){         &print_header;         &print_post_button_bar($this_area);         print <<"EOF";<h4>Your post request cannot be completed because the following fields were left blank: <em>$form_missing</em>.Please complete the form and re-submit.</h4><form method="post" action="$cgi_url"><input type="hidden" name="area" value="$this_area"><input type="hidden" name="mode" value="NEW_POST"><ul><input type="text" name="name" value="$name" size="35"> Your Name<br><input type="text" name="email" value="$email" size="35"> Your Email Address<br><input type="text" name="subject" value="$subject" size="35"> Message Subject<p><textarea name="message_body" rows="15" cols="50">$message_body</textarea></ul><center><input type="submit" value=" Re-Post Message "></center></form>EOF         &print_post_button_bar($this_area);         &print_footer;         exit(0);      }      &load_messages($this_area);      $new_num = $last_message_num + 1;      chop($message_body) if $message_body =~ /\n$/;      $message_body =~ s///g;      $message_body =~ s/\n/`~`/g;      $message_body =~ s/\t/    /g;      foreach $rem (@rem_list){         $message_body =~ s/<[^<>]*$rem[^<>]*>//ig;      }       local($new_val) =  "ORIG" . "\t" . $new_num . "\t" . "NONE" . "\t" . $date_line . "\t" . $name .                "\t" . $email . "\t" . $subject . "\t" . $message_body;      dbmopen(%DB, $message_db, 0666);      $DB{$new_num} = $new_val;      dbmclose(DB);         local($notes_to_pass) = "<center><h4>Your message has been posted " .           "and is displayed below.</h4></center>";      &display_message($this_area, $new_num, $notes_to_pass);    }elsif ($post_mode eq "REPLY"){      local($form_missing) = &check_for_missing;      &load_messages($this_area);      if ($form_missing ne ""){         &print_header;         &print_post_button_bar($this_area);         $msg_poster = $name{$message};         $email_tag = "(<a href=\"mailto:$email{$message}\">" .                      "$email{$message}</a>)";         print <<"EOF";<h4>Your reply request cannot be completed because the following fields were left blank: <em>$form_missing</em>. Please complete the form and re-submit.</h4><b>Date: <em>$date{$message}</em></b><br> <b>Posted By: <em>$msg_poster</em> $email_tag</b><br><b>Subject: <em>$subject{$message}</em></b><p>$message{$message}<p><hr width=95%><p><form method="post" action="$cgi_url"><input type="hidden" name="area" value="$this_area"><input type="hidden" name="message" value="$message"><input type="hidden" name="mode" value="REPLY_POST"><ul><input type="text" name="name" value="$name" size="35"> Your Name<br><input type="text" name="email" value="$email" size="35"> Your Email Address<br><input type="text" name="subject" value="$subject" size="35"> Message Subject<p><textarea name="message_body" rows="15" cols="50">$message_body</textarea></ul><center><input type="submit" value=" Re-Post Your Reply "></center></form>EOF         &print_post_button_bar($this_area);         &print_footer;         exit(0);      }      $new_num = $last_message_num + 1;      chop($message_body) if $message_body =~ /\n$/;      $message_body =~ s///g;      $message_body =~ s/\n/`~`/g;      $message_body =~ s/\t/    /g;      foreach $rem (@rem_list){         $message_body =~ s/<[^<>]*$rem[^<>]*>//ig;      }       local($new_val) = "REPLY" . "\t" . $thread_start{$message} .                 "\t" . $message . "\t" . $date_line . "\t" . $name .                "\t" . $email . "\t" . $subject . "\t" . $message_body . "\n";      dbmopen(%DB, $message_db, 0666);      $DB{$new_num} = $new_val;      dbmclose(DB);      local($notes_to_pass) = "<center><h4>Your reply has been posted " .           "and is displayed below.</h4></center>";      &display_message($this_area, $new_num, $notes_to_pass);    }}# ************************************************************************# Find_Replies - Find all messages whose parent is this one# ************************************************************************sub find_replies{   local($this_parent) = $_[0];   local($ret_list) = "";   foreach $msg_num (@message_nums){      if ($parent{$msg_num} eq $this_parent){         if ($ret_list eq ""){ $ret_list = "$msg_num"; }         else {$ret_list .= ":" . $msg_num; }      }   }   return $ret_list;}# ************************************************************************# Find_Thread - Find all messages who belong to this thread# ************************************************************************sub find_thread{   local($this_parent) = $_[0];   local($ret_list) = "";   foreach $msg_num (@message_nums){      if (($thread_start{$msg_num} eq $this_parent) && ($msg_num ne $this_parent)){         if ($ret_list eq ""){ $ret_list = "$msg_num"; }         else {$ret_list .= ":" . $msg_num; }      }   }   return $ret_list;}# ************************************************************************# Check_Reply - Check if there are any replies for specified message# ************************************************************************sub check_reply{   local($this_message) = $_[0];   for ($i = $this_message; $i <= $last_message_num; $i++){      if (($this_message ne $i) && ($thread_start{$i} eq $thread_start{$this_message})          && ($status{$i} !~ /EXPIRED/)){         return $i;      }   }   return "NONE";}# ************************************************************************# Check_Prev - Find Previous message in reply chain # ************************************************************************sub check_prev{   local($this_message) = $_[0];   for ($i = $this_message; $i >= 1; $i--){      if (($this_message ne $i) && ($thread_start{$i} eq $thread_start{$this_message})          && ($status{$i} !~ /EXPIRED/)){         return $i;      }   }   return "NONE";}# ************************************************************************1;  # Return a true value# ************************************************************************# End of Module:  # ************************************************************************